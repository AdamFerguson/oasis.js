output "dist"

class BrowserIIFE < Rake::Pipeline::Filter
  def initialize(options, &block)
    super(&block)

    @type = options[:type]
    @into = "Oasis" + options[:type].capitalize
  end

  def generate_output(inputs, output)
    inputs.each do |file|
      output.write %{(function(exports) {\n#{file.read}\nexports.#{@into} = requireModule('oasis/#{@type}');\n})(window);}
    end
  end
end

require "js_module_transpiler"
require "pry"

class ModuleTranspiler < Rake::Pipeline::Filter
  def initialize(options, &block)
    @type = options[:type]
    @name = options[:name]
    @into = options[:into]
    super(&block)
  end

  def generate_output(inputs, output)
    inputs.each do |input|
      converter = JsModuleTranspiler::Compiler.new(input.read, @name, into: @into)
      output.write converter.send("to_#{@type}")
    end
  end
end

input "lib" do
  match "environment.js" do
    filter ModuleTranspiler, name: "oasis/environment", type: :amd
    concat { ["oasis.environment.amd.js", "oasis.environment.js" ] }
  end

  match "{loader,rsvp.amd,oasis.environment}.js" do
    concat ["loader.js", "rsvp.amd.js", "oasis.environment.js"], "oasis.environment.js"
    filter BrowserIIFE, { type: 'environment' }
  end
end

input "lib" do
  match "sandbox.js" do
    filter ModuleTranspiler, name: "oasis/sandbox", type: :amd
    concat { ["oasis.sandbox.amd.js", "oasis.sandbox.js" ] }
  end

  match "{loader,rsvp.amd,oasis.sandbox}.js" do
    concat ["loader.js", "rsvp.amd.js", "oasis.sandbox.js"], "oasis.sandbox.js"
    filter BrowserIIFE, { type: 'sandbox' }
  end
end

input "test" do
  output "tests"
  concat
end

# vim: filetype=ruby
